<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DashStack - Lập phiếu đăng ký</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body class="bg-light">
    <script>
      if (localStorage.getItem("isLoggedIn") !== "true") {
        window.location.href = "login.html";
      }
    </script>
    <div class="d-flex">
      <!-- Sidebar -->
      <nav class="sidebar min-vh-100 p-3 bg-white d-flex flex-column">
        <ul class="nav nav-pills flex-column mb-2">
          <li class="nav-item">
            <a
              href="dang-ky.html"
              class="nav-link active d-flex align-items-center mb-2"
            >
              <i data-feather="edit" class="me-3"></i> Đăng ký
            </a>
          </li>
          <li class="nav-item">
            <a
              href="xem-phieu-dang-ky.html"
              class="nav-link text-secondary d-flex align-items-center mb-2"
            >
              <i data-feather="file-text" class="me-3"></i> Xem phiếu đăng ký
            </a>
          </li>
          <li class="nav-item">
            <a
              href="xem-lich-thi.html"
              class="nav-link text-secondary d-flex align-items-center mb-2"
            >
              <i data-feather="calendar" class="me-3"></i> Xem lịch thi
            </a>
          </li>
          <li class="nav-item">
            <a
              href="tra-cuu-chung-chi.html"
              class="nav-link text-secondary d-flex align-items-center mb-2"
            >
              <i data-feather="search" class="me-3"></i> Tra cứu chứng chỉ
            </a>
          </li>
          <li class="nav-item">
            <a
              href="#"
              id="logout-link"
              class="nav-link text-secondary d-flex align-items-center mb-2"
            >
              <i data-feather="log-out" class="me-3"></i> Logout
            </a>
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="main-content flex-grow-1 p-4">
        <header class="d-flex justify-content-between align-items-center mb-4">
          <div class="d-flex align-items-center">
            <button
              class="btn btn-outline-secondary me-3"
              onclick="history.back()"
            >
              <i data-feather="arrow-left" class="me-1"></i> Quay lại
            </button>
            <h1 class="h3 mb-0">Xin chào, nhân viên tiếp nhận</h1>
          </div>
        </header>
        <h2 class="mb-4">Tạo phiếu đăng ký</h2>
        <div class="content-wrapper p-5 bg-white rounded-3 shadow-sm">
          <form id="registrationForm">
            <!-- Người đăng ký -->
            <h3 class="fs-5 mb-3">Thông tin người đăng ký</h3>
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label">Họ tên</label>
                <input type="text" class="form-control" id="customerName" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Số điện thoại</label>
                <input type="text" class="form-control" id="customerPhone" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Ngày sinh</label>
                <input type="date" class="form-control" id="customerDob" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="customerEmail" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Địa chỉ</label>
                <input type="text" class="form-control" id="customerAddress" />
              </div>
            </div>

            <!-- Thông tin đơn vị -->
            <h3 class="fs-5 mb-3">Thông tin đơn vị</h3>
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label">Tên đơn vị</label>
                <input type="text" class="form-control" id="companyName" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Số điện thoại</label>
                <input type="text" class="form-control" id="companyPhone" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Địa chỉ</label>
                <input type="text" class="form-control" id="companyAddress" />
              </div>
            </div>

            <!-- Danh sách thí sinh -->
            <div class="d-flex justify-content-between">
              <h3 class="fs-5 mb-3">Thông tin thí sinh</h3>
              <div class="d-flex justify-content-end mb-3">
                <button
                  type="button"
                  class="btn btn-primary"
                  id="addCandidateBtn"
                >
                  Thêm thí sinh
                </button>
              </div>
            </div>
            <div id="candidates-list">
              <div class="row g-3 mb-4 align-items-end candidate-row">
                <div class="col-md-4">
                  <label class="form-label">Tên người dự thi</label>
                  <input
                    type="text"
                    class="form-control"
                    name="candidateName[]"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Số điện thoại</label>
                  <input
                    type="text"
                    class="form-control"
                    name="candidatePhone[]"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Ngày sinh</label>
                  <input
                    type="date"
                    class="form-control"
                    name="candidateDob[]"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    name="candidateEmail[]"
                  />
                </div>
                <div class="col-md-8">
                  <label class="form-label">Địa chỉ</label>
                  <input
                    type="text"
                    class="form-control"
                    name="candidateAddress[]"
                  />
                </div>
              </div>
            </div>

            <!-- Lịch thi -->
            <h3 class="fs-5 mb-3">Lịch thi</h3>
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label">Loại chứng chỉ</label>
                <select class="form-select" id="examRank">
                  <option value="">Chọn</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Tên kỳ thi</label>
                <select class="form-select" id="examTest">
                  <option value="">Chọn</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Thời gian thi</label>
                <select class="form-select" id="examDate">
                  <option value="">Chọn</option>
                </select>
              </div>
            </div>

            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-primary btn-lg">
                Lập phiếu
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>
    <!-- Modal Bootstrap -->
    <div
      class="modal fade"
      id="successModal"
      tablogin="-1"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="successModalLabel">Thông báo</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Lập phiếu thành công!</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      feather.replace();

      let scheduleList = []; // Toàn bộ dữ liệu lịch thi

      // Template dòng thí sinh (biến global để dùng lại)
      const createCandidateRowTemplate = () => `
    <div class="row g-3 mb-4 align-items-end candidate-row">
      <div class="col-md-4">
        <label class="form-label">Tên người dự thi</label>
        <input type="text" class="form-control" name="candidateName[]" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Số điện thoại</label>
        <input type="text" class="form-control" name="candidatePhone[]" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Ngày sinh</label>
        <input type="date" class="form-control" name="candidateDob[]" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" name="candidateEmail[]" />
      </div>
      <div class="col-md-8">
        <label class="form-label">Địa chỉ</label>
        <input type="text" class="form-control" name="candidateAddress[]" />
      </div>
    </div>
  `;

      document.addEventListener("DOMContentLoaded", function () {
        const rankSelect = document.getElementById("examRank");
        const testSelect = document.getElementById("examTest");
        const dateSelect = document.getElementById("examDate");

        // Load dữ liệu từ backend
        fetch("http://localhost:8080/api/v1/schedules")
          .then((res) => res.json())
          .then((data) => {
            if (Array.isArray(data.data)) {
              scheduleList = data.data;
              renderOptions(scheduleList);
            }
          })
          .catch((err) => {
            console.error("Lỗi tải lịch thi:", err);
          });

        function renderOptions(data) {
          const uniqueRanks = new Set();
          const uniqueTests = new Set();
          const uniqueDates = new Set();

          data.forEach((item) => {
            uniqueRanks.add(item.certificationName);
            uniqueTests.add(item.nameTest);

            const [year, month, day] = item.date.split("-");
            const [hour, minute] = item.time.split(":");

            // Tạo đối tượng Date
            const dateObj = new Date(`${item.date}T${item.time}`);

            // Format giờ AM/PM
            const hours = dateObj.getHours();
            const formattedHours = (((hours + 11) % 12) + 1)
              .toString()
              .padStart(2, "0");
            const ampm = hours >= 12 ? "PM" : "AM";

            const formattedTime = `${formattedHours}:${minute} ${ampm}`;
            const formattedDate = `${day}/${month}/${year}`;

            uniqueDates.add(`${formattedTime} ${formattedDate}`);
          });

          fillSelect(rankSelect, Array.from(uniqueRanks), "Chọn");
          fillSelect(testSelect, Array.from(uniqueTests), "Chọn");
          fillSelect(dateSelect, Array.from(uniqueDates), "Chọn");
        }

        function fillSelect(selectElement, items, placeholder) {
          selectElement.innerHTML = `<option value="">${placeholder}</option>`;
          items.forEach((item) => {
            const opt = document.createElement("option");
            opt.value = item;
            opt.text = item;
            selectElement.appendChild(opt);
          });
        }

        function handleSelectChange(source) {
          const selectedRank = rankSelect.value;
          const selectedTest = testSelect.value;
          const selectedDate = dateSelect.value;

          const filtered = scheduleList.filter((item) => {
            const matchRank =
              !selectedRank || item.certificationName === selectedRank;
            const matchTest = !selectedTest || item.nameTest === selectedTest;

            // Format ngày giờ về: HH:mm AM/PM DD/MM/YYYY
            const dateObj = new Date(`${item.date}T${item.time}`);
            const hours = dateObj.getHours();
            const minutes = dateObj.getMinutes().toString().padStart(2, "0");
            const formattedHours = (((hours + 11) % 12) + 1)
              .toString()
              .padStart(2, "0");
            const ampm = hours >= 12 ? "PM" : "AM";
            const day = dateObj.getDate().toString().padStart(2, "0");
            const month = (dateObj.getMonth() + 1).toString().padStart(2, "0");
            const year = dateObj.getFullYear();

            const fullDateTime = `${formattedHours}:${minutes} ${ampm} ${day}/${month}/${year}`;
            const matchDate = !selectedDate || fullDateTime === selectedDate;

            return matchRank && matchTest && matchDate;
          });

          // Cập nhật lại từng select nếu không phải source
          if (source !== "rank") {
            const ranks = [
              ...new Set(filtered.map((i) => i.certificationName)),
            ];
            fillSelect(rankSelect, ranks, "Chọn");
            if (selectedRank) rankSelect.value = selectedRank;
          }

          if (source !== "test") {
            const tests = [...new Set(filtered.map((i) => i.nameTest))];
            fillSelect(testSelect, tests, "Chọn");
            if (selectedTest) testSelect.value = selectedTest;
          }

          if (source !== "date") {
            const dates = [
              ...new Set(
                filtered.map((item) => {
                  const dateObj = new Date(`${item.date}T${item.time}`);
                  const hours = dateObj.getHours();
                  const minutes = dateObj
                    .getMinutes()
                    .toString()
                    .padStart(2, "0");
                  const formattedHours = (((hours + 11) % 12) + 1)
                    .toString()
                    .padStart(2, "0");
                  const ampm = hours >= 12 ? "PM" : "AM";
                  const day = dateObj.getDate().toString().padStart(2, "0");
                  const month = (dateObj.getMonth() + 1)
                    .toString()
                    .padStart(2, "0");
                  const year = dateObj.getFullYear();
                  return `${formattedHours}:${minutes} ${ampm} ${day}/${month}/${year}`;
                })
              ),
            ];
            fillSelect(dateSelect, dates, "Chọn");
            if (selectedDate) dateSelect.value = selectedDate;
          }
        }

        function getSelectedScheduleId() {
          const selectedRank = rankSelect.value;
          const selectedTest = testSelect.value;
          const selectedDate = dateSelect.value;

          if (!selectedRank || !selectedTest || !selectedDate) return null;

          const found = scheduleList.find((item) => {
            // Format lại ngày giờ giống với selectedDate
            const dateObj = new Date(`${item.date}T${item.time}`);
            const hours = dateObj.getHours();
            const minutes = dateObj.getMinutes().toString().padStart(2, "0");
            const formattedHours = (((hours + 11) % 12) + 1)
              .toString()
              .padStart(2, "0");
            const ampm = hours >= 12 ? "PM" : "AM";
            const day = dateObj.getDate().toString().padStart(2, "0");
            const month = (dateObj.getMonth() + 1).toString().padStart(2, "0");
            const year = dateObj.getFullYear();

            const fullDateTime = `${formattedHours}:${minutes} ${ampm} ${day}/${month}/${year}`;

            return (
              item.certificationName === selectedRank &&
              item.nameTest === selectedTest &&
              fullDateTime === selectedDate
            );
          });

          return found ? found.id : null;
        }

        rankSelect.addEventListener("change", () => handleSelectChange("rank"));
        testSelect.addEventListener("change", () => handleSelectChange("test"));
        dateSelect.addEventListener("change", () => handleSelectChange("date"));

        // Thêm thí sinh mới
        document
          .getElementById("addCandidateBtn")
          .addEventListener("click", function () {
            const container = document.getElementById("candidates-list");
            const div = document.createElement("div");
            div.innerHTML = createCandidateRowTemplate();
            container.appendChild(div);
          });

        // Logout
        document
          .getElementById("logout-link")
          .addEventListener("click", function (e) {
            e.preventDefault();
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("id");
            localStorage.removeItem("token");
            window.location.href = "login.html";
          });

        // Xử lý submit form
        $(document).ready(function () {
          $("#registrationForm").submit(function (e) {
            e.preventDefault();

            const registrant = {
              name: $("#customerName").val(),
              phone: $("#customerPhone").val(),
              dob: $("#customerDob").val(),
              email: $("#customerEmail").val(),
              address: $("#customerAddress").val(),
              noc: $("#companyName").val(),
              poc: $("#companyPhone").val(),
              aoc: $("#companyAddress").val(),
            };

            const candidates = [];
            $("#candidates-list .candidate-row").each(function () {
              const candidate = {
                name: $(this).find('input[name="candidateName[]"]').val(),
                phone: $(this).find('input[name="candidatePhone[]"]').val(),
                dob: $(this).find('input[name="candidateDob[]"]').val(),
                email: $(this).find('input[name="candidateEmail[]"]').val(),
                address: $(this).find('input[name="candidateAddress[]"]').val(),
              };
              candidates.push(candidate);
            });

            const scheduleId = getSelectedScheduleId();
            if (!scheduleId) {
              alert("Vui lòng chọn đầy đủ lịch thi");
              return;
            }

            const today = new Date().toISOString().split("T")[0];
            const data = {
              registrantType: "DON_VI",
              registrant,
              date: today,
              status: "Chưa thanh toán",
              candidates,
              staffId: localStorage.getItem("id"),
              testScheduleId: scheduleId,
            };

            $.ajax({
              url: "http://localhost:8080/api/v1/regis",
              type: "POST",
              contentType: "application/json",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("token"),
              },
              data: JSON.stringify(data),
              success: function (response) {
                const successModal = new bootstrap.Modal(
                  document.getElementById("successModal")
                );
                successModal.show();

                $("#registrationForm")[0].reset();
                $("#candidates-list").html(createCandidateRowTemplate());
              },
              error: function (xhr, status, error) {
                console.error("Lỗi:", xhr.responseText || error);
                alert("Đăng ký thất bại. Vui lòng kiểm tra lại thông tin.");
              },
            });
          });
        });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
